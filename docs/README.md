# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è beeralex.reviews

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
4. [–ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏](#–±–∞–∑–æ–≤—ã–µ-–∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
5. [ReviewsService](#reviewsservice)
6. [ReviewCreatorService](#reviewcreatorservice)
7. [UploadService](#uploadservice)
8. [ReviewDTO](#reviewdto)
9. [–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](#—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
10. [–ò–º–ø–æ—Ä—Ç –æ—Ç–∑—ã–≤–æ–≤](#–∏–º–ø–æ—Ä—Ç-–æ—Ç–∑—ã–≤–æ–≤)
11. [REST API](#rest-api)
12. [–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞](#—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞)
13. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## –û–±–∑–æ—Ä

**beeralex.reviews** ‚Äî –º–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞–º–∏ –≤ Bitrix —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:

- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- üìÅ **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤** (—Ñ–æ—Ç–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã) –∫ –æ—Ç–∑—ã–≤–∞–º
- üîê **–ú–æ–¥–µ—Ä–∞—Ü–∏—è** ‚Äî –Ω–æ–≤—ã–µ –æ—Ç–∑—ã–≤—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å —Ñ–ª–∞–≥–æ–º ACTIVE='N'
- üë§ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∏ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚≠ê **–†–µ–π—Ç–∏–Ω–≥** –æ—Ç 1 –¥–æ 5 –∑–≤–µ–∑–¥
- üì• **–ò–º–ø–æ—Ä—Ç –æ—Ç–∑—ã–≤–æ–≤** –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º (2GIS)
- üîÑ **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** –æ—Ç–∑—ã–≤–æ–≤ (–Ω–æ–≤—ã–µ/—Å—Ç–∞—Ä—ã–µ)
- üåê **REST API** –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ DTO —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ PHP 8.1+
- Contract-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
- –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏–Ω—Ñ–æ–±–ª–æ–∫–µ Bitrix
- –ì–æ—Ç–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º `beeralex.api`
- –†–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–º–ø–æ—Ä—Ç–∞ –æ—Ç–∑—ã–≤–æ–≤

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         ReviewsService                       ‚îÇ
‚îÇ  (–§–∞—Å–∞–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ  ReviewCreatorService       ‚îÇ
      ‚îÇ  (implements CreatorContract)‚îÇ
      ‚îî‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îò
        ‚îÇ                          ‚îÇ
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ UploadService ‚îÇ      ‚îÇReviewsRepository ‚îÇ
  ‚îÇ  (–∑–∞–≥—Ä—É–∑–∫–∞    ‚îÇ      ‚îÇ  (—Ä–∞–±–æ—Ç–∞ —Å –ë–î)   ‚îÇ
  ‚îÇ   —Ñ–∞–π–ª–æ–≤)     ‚îÇ      ‚îÇ                  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **ReviewsService** ‚Äî —Ñ–∞—Å–∞–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤
2. **ReviewCreatorService** ‚Äî –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
3. **UploadService** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫ –æ—Ç–∑—ã–≤—É
4. **ReviewsRepository** ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–º –æ—Ç–∑—ã–≤–æ–≤
5. **ReviewDTO** ‚Äî –æ–±—ä–µ–∫—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
6. **Import/** ‚Äî –∏–º–ø–æ—Ä—Ç –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
7. **SortingRepository** ‚Äî —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- PHP 8.1+
- Bitrix Framework 22.0+
- –ú–æ–¥—É–ª—å `beeralex.core` (–±–∞–∑–æ–≤—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏)
- –ú–æ–¥—É–ª—å `beeralex.api` (–¥–ª—è REST API)
- –ò–Ω—Ñ–æ–±–ª–æ–∫ —Å –∫–æ–¥–æ–º `product_reviews`

### –ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏

1. –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ –º–æ–¥—É–ª—å –≤ `/local/modules/beeralex.reviews/`
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å
3. –ú–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å—ã –≤ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
4. –°–æ–∑–¥–∞–π—Ç–µ –∏–Ω—Ñ–æ–±–ª–æ–∫ "–û—Ç–∑—ã–≤—ã" —Å –∫–æ–¥–æ–º `product_reviews`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞

**–ö–æ–¥ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞:** `product_reviews`

**–°–≤–æ–π—Å—Ç–≤–∞:**

```
USER_NAME       (string)  - –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
EVAL            (number)  - –û—Ü–µ–Ω–∫–∞ (1-5)
REVIEW          (text)    - –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ (HTML)
CONTACT_DETAILS (string)  - –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (email/—Ç–µ–ª–µ—Ñ–æ–Ω)
ELEMENT_ID      (number)  - ID —Ç–æ–≤–∞—Ä–∞/—ç–ª–µ–º–µ–Ω—Ç–∞
USER            (number)  - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Bitrix (–µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
FILES           (file)    - –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ)
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**

- `ACTIVE` ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'N' (–º–æ–¥–µ—Ä–∞—Ü–∏—è)
- `IBLOCK_SECTION_ID` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Ç–æ–≤–∞—Ä–∞ (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ, –Ω–æ —Ç–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

---

## –ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### ReviewDTO

DTO (Data Transfer Object) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç—ã PHP 8.1+.

```php
namespace Beeralex\Reviews\Dto;

use Beeralex\Core\Http\Request\AbstractRequestDto;
use Bitrix\Main\Validation\Rule\*;

class ReviewDTO extends AbstractRequestDto
{
    #[NotEmpty(errorMessage: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ')]
    #[Length(min: 2, max: 100, errorMessage: '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤')]
    public string $userName = '–ê–Ω–æ–Ω–∏–º';

    #[NotEmpty(errorMessage: '–û—Ü–µ–Ω–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞')]
    #[Min(value: 1, errorMessage: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ - 1')]
    #[Max(value: 5, errorMessage: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ - 5')]
    public int $eval;

    #[NotEmpty(errorMessage: '–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω')]
    #[Length(min: 10, max: 5000, errorMessage: '–û—Ç–∑—ã–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 10 –¥–æ 5000 —Å–∏–º–≤–æ–ª–æ–≤')]
    public string $review;

    public ?string $contactDetails = null;

    #[NotEmpty(errorMessage: 'ID —ç–ª–µ–º–µ–Ω—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω')]
    public int $elementId;

    public ?int $userId = null;
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:**
- –ü—Ä–∏ –±–∏–Ω–¥–∏–Ω–≥–µ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ API
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `$dto->isValid()`
- –û—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `$dto->getErrors()`

### Contracts

**CreatorContract** ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤:

```php
interface CreatorContract
{
    public function create(ReviewDTO $dto, array $files): Result;
}
```

**FileUploaderContract** ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:

```php
interface FileUploaderContract
{
    public function upload(array $files): array;
}
```

---

## ReviewsService

–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞—Å–∞–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–∑—ã–≤–∞–º–∏. –£–ø—Ä–æ—â–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤.

### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```php
public function __construct(
    protected readonly CreatorContract $creator
)
```

### –ú–µ—Ç–æ–¥—ã

#### `add(ReviewDTO $dto, array $files): Result`

–î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–∑—ã–≤ —Å —Ñ–∞–π–ª–∞–º–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `$dto` ‚Äî –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π DTO —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç–∑—ã–≤–∞
- `$files` ‚Äî –º–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤ –∏–∑ `$_FILES`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `Result` ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å `elementId` –≤ –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–º–µ—Ä:**

```php
use Beeralex\Reviews\Services\ReviewsService;
use Beeralex\Reviews\Dto\ReviewDTO;

$service = service(ReviewsService::class);

$dto = new ReviewDTO();
$dto->userName = '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤';
$dto->eval = 5;
$dto->review = '–û—Ç–ª–∏—á–Ω—ã–π —Ç–æ–≤–∞—Ä, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é!';
$dto->elementId = 123; // ID —Ç–æ–≤–∞—Ä–∞
$dto->userId = 100;     // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)

$result = $service->add($dto, $_FILES);

if ($result->isSuccess()) {
    $elementId = $result->getData()['elementId'];
    echo "–û—Ç–∑—ã–≤ —Å–æ–∑–¥–∞–Ω —Å ID: {$elementId}";
} else {
    foreach ($result->getErrors() as $error) {
        echo $error->getMessage() . "\n";
    }
}
```

---

## ReviewCreatorService

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `CreatorContract`. –°–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞.

### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```php
public function __construct(
    protected readonly FileUploaderContract $fileUploader,
    protected readonly ReviewsRepository $repository
)
```

### –ú–µ—Ç–æ–¥—ã

#### `create(ReviewDTO $dto, array $files): Result`

–°–æ–∑–¥–∞–µ—Ç –æ—Ç–∑—ã–≤ –≤ –∏–Ω—Ñ–æ–±–ª–æ–∫–µ.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è DTO
2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞ (`prepareElementData()`)
3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ `fileUploader`
4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∏–Ω—Ñ–æ–±–ª–æ–∫
5. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å ID —ç–ª–µ–º–µ–Ω—Ç–∞

**–ü—Ä–∏–º–µ—Ä:**

```php
use Beeralex\Reviews\Services\ReviewCreatorService;
use Beeralex\Reviews\Dto\ReviewDTO;

$creator = service(CreatorContract::class);

$dto = new ReviewDTO();
$dto->userName = '–ú–∞—Ä–∏—è';
$dto->eval = 4;
$dto->review = '–•–æ—Ä–æ—à–∏–π —Ç–æ–≤–∞—Ä, –±—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞';
$dto->elementId = 456;

$result = $creator->create($dto, []);

if (!$result->isSuccess()) {
    print_r($result->getErrorMessages());
}
```

#### `prepareElementData(ReviewDTO $dto): array` (protected)

–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∏–Ω—Ñ–æ–±–ª–æ–∫.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**

```php
[
    'NAME' => '–û—Ç–∑—ã–≤ –æ—Ç –ò–º—è',
    'ACTIVE' => 'N',  // –ú–æ–¥–µ—Ä–∞—Ü–∏—è
    'IBLOCK_SECTION_ID' => $dto->elementId,  // ID —Ç–æ–≤–∞—Ä–∞
    'PROPERTY_VALUES' => [
        'USER_NAME' => '...',
        'EVAL' => 5,
        'REVIEW' => ['TEXT' => '...', 'TYPE' => 'HTML'],
        'CONTACT_DETAILS' => '...',
        'ELEMENT_ID' => 123,
        'USER' => 100,  // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    ]
]
```

‚ö†Ô∏è **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** `IBLOCK_SECTION_ID` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Ç–æ–≤–∞—Ä–∞ (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ).

#### `handleFiles(array $files): array` (protected)

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.

```php
$fileIds = $this->handleFiles($_FILES);
// [123, 456, 789]
```

---

## UploadService

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `FileUploaderContract`. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –≤ Bitrix.

### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```php
public function __construct(
    protected readonly FileService $fileService  // –∏–∑ beeralex.core
)
```

### –ú–µ—Ç–æ–¥—ã

#### `upload(array $files): array`

–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –∏—Ö ID.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `$files` ‚Äî –º–∞—Å—Å–∏–≤ –∏–∑ `$_FILES`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `array` ‚Äî –º–∞—Å—Å–∏–≤ ID –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ `[123, 456, ...]`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ `FileService::getFormattedToSafe()`
2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ `CFile::SaveFile()`
3. –í–æ–∑–≤—Ä–∞—Ç –º–∞—Å—Å–∏–≤–∞ ID

**–ü—Ä–∏–º–µ—Ä:**

```php
use Beeralex\Reviews\Services\UploadService;

$uploader = service(FileUploaderContract::class);
$fileIds = $uploader->upload($_FILES);

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ID –¥–ª—è —Å–≤–æ–π—Å—Ç–≤–∞ FILES
$elementData['PROPERTY_VALUES']['FILES'] = $fileIds;
```

---

## ReviewDTO

### –°–≤–æ–π—Å—Ç–≤–∞

| –°–≤–æ–π—Å—Ç–≤–æ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –í–∞–ª–∏–¥–∞—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|-------------|-----------|----------|
| `userName` | string | –î–∞ | 2-100 —Å–∏–º–≤–æ–ª–æ–≤ | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é '–ê–Ω–æ–Ω–∏–º') |
| `eval` | int | –î–∞ | 1-5 | –û—Ü–µ–Ω–∫–∞ (—Ä–µ–π—Ç–∏–Ω–≥) |
| `review` | string | –î–∞ | 10-5000 —Å–∏–º–≤–æ–ª–æ–≤ | –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ |
| `contactDetails` | ?string | –ù–µ—Ç | - | Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω |
| `elementId` | int | –î–∞ | NotEmpty | ID —Ç–æ–≤–∞—Ä–∞/—ç–ª–µ–º–µ–Ω—Ç–∞ |
| `userId` | ?int | –ù–µ—Ç | - | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Bitrix |

### –ú–µ—Ç–æ–¥—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏

#### `isValid(): bool`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

```php
$dto = new ReviewDTO();
$dto->userName = '–ê'; // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ

if (!$dto->isValid()) {
    foreach ($dto->getErrors() as $error) {
        echo $error->getMessage() . "\n";
    }
}
// –í—ã–≤–µ–¥–µ—Ç: "–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤"
```

#### `getErrors(): array`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

```php
$errors = $dto->getErrors();
// [Error object, Error object, ...]

foreach ($errors as $error) {
    echo $error->getMessage() . "\n";
    print_r($error->getCustomData());
}
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```php
use Beeralex\Reviews\Dto\ReviewDTO;

// –°–æ–∑–¥–∞–Ω–∏–µ DTO –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∏–Ω–¥–∏–Ω–≥ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ)
public function storeAction(ReviewDTO $review)
{
    // $review —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ $_POST –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω
    $files = $this->getRequest()->getFileList()->toArray();
    return service(ReviewsService::class)->add($review, $files);
}

// –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ DTO
$dto = new ReviewDTO();
$dto->userName = '–ü–µ—Ç—Ä –ò–≤–∞–Ω–æ–≤';
$dto->eval = 5;
$dto->review = '–û—Ç–ª–∏—á–Ω—ã–π —Ç–æ–≤–∞—Ä, –æ—á–µ–Ω—å –¥–æ–≤–æ–ª–µ–Ω –ø–æ–∫—É–ø–∫–æ–π!';
$dto->contactDetails = 'petr@example.com';
$dto->elementId = 123;
$dto->userId = null; // –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

if ($dto->isValid()) {
    service(ReviewsService::class)->add($dto, []);
}
```

---

## –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

### ReviewsRepository

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–º –æ—Ç–∑—ã–≤–æ–≤.

**–ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç:** `Beeralex\Core\Repository\IblockRepository`

```php
class ReviewsRepository extends IblockRepository
{
    // –ù–∞—Å–ª–µ–¥—É–µ—Ç –≤—Å–µ –º–µ—Ç–æ–¥—ã –±–∞–∑–æ–≤–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
}
```

#### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```php
public function __construct()
{
    parent::__construct('product_reviews'); // –ö–æ–¥ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞
}
```

#### –£–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã

**`add(array $data): int`**

–î–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –≤ –∏–Ω—Ñ–æ–±–ª–æ–∫.

```php
$repo = service(ReviewsRepository::class);

$elementId = $repo->add([
    'NAME' => '–û—Ç–∑—ã–≤ –æ—Ç –ò–≤–∞–Ω',
    'ACTIVE' => 'N',
    'PROPERTY_VALUES' => [
        'USER_NAME' => '–ò–≤–∞–Ω',
        'EVAL' => 5,
        'REVIEW' => ['TEXT' => '–û—Ç–ª–∏—á–Ω–æ!', 'TYPE' => 'HTML'],
        'ELEMENT_ID' => 123,
    ]
]);
```

**`all(array $filter, array $select, array $order): array`**

–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –æ—Ç–∑—ã–≤—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π.

```php
// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç–∑—ã–≤—ã —Ç–æ–≤–∞—Ä–∞
$reviews = $repo->all(
    ['IBLOCK_SECTION_ID' => 123, 'ACTIVE' => 'Y'],
    ['ID', 'NAME', 'PROPERTY_USER_NAME', 'PROPERTY_EVAL'],
    ['ID' => 'DESC']
);
```

**`one(array $filter, array $select): ?array`**

–ü–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω –æ—Ç–∑—ã–≤.

```php
$review = $repo->one(['ID' => 456]);
```

**`update(int $id, array $data): void`**

–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∑—ã–≤.

```php
$repo->update(456, [
    'ACTIVE' => 'Y', // –û–¥–æ–±—Ä–∏—Ç—å –æ—Ç–∑—ã–≤
]);
```

**`delete(int $id): void`**

–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤.

```php
$repo->delete(456);
```

### SortingRepository

–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫ –æ—Ç–∑—ã–≤–æ–≤.

**–†–µ–∞–ª–∏–∑—É–µ—Ç:** `SortingRepositoryContract`

```php
class SortingRepository extends Repository implements SortingRepositoryContract
{
    public function all(...): array
    {
        return [
            [
                'ID' => 1,
                'NAME' => '–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ',
                'CODE' => 'new',
                'SORT_BY' => ['VALUE' => 'ID'],
                'DIRECTION' => ['VALUE' => 'DESC'],
            ],
            [
                'ID' => 2,
                'NAME' => '–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ',
                'CODE' => 'old',
                'SORT_BY' => ['VALUE' => 'ID'],
                'DIRECTION' => ['VALUE' => 'ASC'],
            ],
        ];
    }

    public function getDefaultSorting(...): ?array
    {
        return $this->one(['ID' => 1]);
    }
}
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```php
use Beeralex\Reviews\Repository\SortingRepository;

$sortingRepo = service(DIServiceKey::SORTING_REPOSITORY->value);

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
$sortings = $sortingRepo->all();

// –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
$default = $sortingRepo->getDefaultSorting();
// ['ID' => 1, 'NAME' => '–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ', 'CODE' => 'new', ...]
```

---

## –ò–º–ø–æ—Ä—Ç –æ—Ç–∑—ã–≤–æ–≤

### BaseImport (abstract)

–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

‚ö†Ô∏è **–ü–æ–º–µ—á–µ–Ω –∫–∞–∫ @deprecated**. –ê–≤—Ç–æ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –≤–º–µ—Å—Ç–æ –∏–º–ø–æ—Ä—Ç–∞ —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ API –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

#### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```php
public function __construct(ReviewsService $service)
{
    $this->service = $service;
    $this->reviewsRepository = new ReviewsRepository();
}
```

#### –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã

**`process(): void`**

–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –∏–º–ø–æ—Ä—Ç–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö).

#### –ú–µ—Ç–æ–¥—ã

**`import(array $items): void`**

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –æ—Ç–∑—ã–≤–æ–≤.

```php
$items = [
    [
        'form' => [
            'eval' => 5,
            'review' => '–û—Ç–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å',
            'user_name' => '–ò–≤–∞–Ω',
            'element_id' => 123,
        ],
        'files' => $_FILES,
        'tmp_paths' => ['/tmp/img1.jpg', '/tmp/img2.jpg']
    ],
    // ...
];

$importer->import($items);
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø–æ `external_id` –∏ `platform`)
2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ —á–µ—Ä–µ–∑ `ReviewsService`
3. –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

**`downloadFile(string $url): ?array` (protected)**

–°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –ø–æ URL –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –¥–ª—è `$_FILES`.

```php
$file = $this->downloadFile('https://example.com/photo.jpg');
// [
//   'name' => 'tmp_abc123.jpg',
//   'type' => 'image/jpeg',
//   'tmp_name' => '/tmp/tmp_abc123.jpg',
//   'error' => 0,
//   'size' => 12345
// ]
```

**`removeFiles(array $paths): void` (protected)**

–£–¥–∞–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã.

```php
$this->removeFiles(['/tmp/img1.jpg', '/tmp/img2.jpg']);
```

**`setToFiles(array &$result, array $file): void` (protected)**

–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É `$_FILES`.

**`logError(\Throwable $e, $item): void` (protected)**

–õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –∏–º–ø–æ—Ä—Ç–∞ –≤ `/logs/import_error.log`.

### ImportFrom2Gis

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∞ –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ 2GIS API.

‚ö†Ô∏è **–ü–æ–º–µ—á–µ–Ω –∫–∞–∫ @deprecated**.

#### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```php
public function __construct(
    ReviewsService $service, 
    array $branches,  // ID —Ñ–∏–ª–∏–∞–ª–æ–≤ –≤ 2GIS
    string $apiKey    // API –∫–ª—é—á 2GIS
)
```

#### –ú–µ—Ç–æ–¥—ã

**`process(): void`**

–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ 2GIS.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ API 2GIS
2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –æ—Ç–∑—ã–≤—ã (—Ä–µ–π—Ç–∏–Ω–≥ >= 4)
3. –°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
4. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ `import()`

**–ü—Ä–∏–º–µ—Ä:**

```php
use Beeralex\Reviews\Import\ImportFrom2Gis;
use Beeralex\Reviews\Services\ReviewsService;

$importer = new ImportFrom2Gis(
    service: service(ReviewsService::class),
    branches: ['70000001234567890', '70000009876543210'], // ID –∏–∑ 2GIS
    apiKey: 'your_2gis_api_key'
);

$importer->process();
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –æ—Ç–∑—ã–≤—ã —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º >= 4
```

**`fetch(string $url): ?array` (protected)**

–í—ã–ø–æ–ª–Ω—è–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å –∫ API 2GIS.

**`downloadPhotos(array $review): array` (protected)**

–°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–∑ –æ—Ç–∑—ã–≤–∞ 2GIS.

---

## REST API

–ú–æ–¥—É–ª—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å `beeralex.api` —á–µ—Ä–µ–∑ `ReviewController`.

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### `GET /api/v1/review/index/`

–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| `count` | int | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20) |
| `product_id` | int | ID —Ç–æ–≤–∞—Ä–∞ |
| `search` | string | –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å |
| `filter` | bool | –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é |

**–ü—Ä–∏–º–µ—Ä:**

```javascript
fetch('/api/v1/review/index/?product_id=123&count=10')
  .then(res => res.json())
  .then(data => {
    console.log('–û—Ç–∑—ã–≤—ã:', data);
  });
```

#### `POST /api/v1/review/store/`

–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (multipart/form-data):**

```
userName: "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"
eval: 5
review: "–û—Ç–ª–∏—á–Ω—ã–π —Ç–æ–≤–∞—Ä!"
contactDetails: "ivan@example.com"
elementId: 123
files[]: (file)
files[]: (file)
```

**–ü—Ä–∏–º–µ—Ä (JavaScript):**

```javascript
const formData = new FormData();
formData.append('userName', '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤');
formData.append('eval', 5);
formData.append('review', '–û—Ç–ª–∏—á–Ω—ã–π —Ç–æ–≤–∞—Ä, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é!');
formData.append('elementId', 123);
formData.append('files[]', fileInput.files[0]);
formData.append('files[]', fileInput.files[1]);

fetch('/api/v1/review/store/', {
  method: 'POST',
  body: formData
})
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      console.log('–û—Ç–∑—ã–≤ —Å–æ–∑–¥–∞–Ω —Å ID:', data.data.elementId);
    } else {
      console.error('–û—à–∏–±–∫–∏:', data.errors);
    }
  });
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**

```json
{
  "status": "success",
  "data": {
    "elementId": 456
  }
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏):**

```json
{
  "status": "error",
  "errors": [
    {
      "message": "–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤",
      "code": "review_create"
    },
    {
      "message": "–û—Ç–∑—ã–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 10 –¥–æ 5000 —Å–∏–º–≤–æ–ª–æ–≤",
      "code": "review_create"
    }
  ]
}
```

---

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Ç–∑—ã–≤

–°–æ–∑–¥–∞–π—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å:

```php
namespace App\Reviews\Services;

use Beeralex\Reviews\Services\ReviewCreatorService as BaseCreator;
use Beeralex\Reviews\Dto\ReviewDTO;
use Bitrix\Main\Result;

class ReviewCreatorService extends BaseCreator
{
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ—Ç–≤–µ—Ç–æ–º
     */
    public function create(ReviewDTO $dto, array $files): Result
    {
        $result = parent::create($dto, $files);

        if ($result->isSuccess()) {
            $elementId = $result->getData()['elementId'];
            $this->sendAutoReply($elementId, $dto);
        }

        return $result;
    }

    protected function sendAutoReply(int $elementId, ReviewDTO $dto): void
    {
        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å email —Å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é
        \CEvent::Send(
            'REVIEW_AUTO_REPLY',
            's1',
            [
                'USER_NAME' => $dto->userName,
                'EMAIL' => $dto->contactDetails,
                'REVIEW_ID' => $elementId,
            ]
        );
    }
}
```

–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤ `/local/.settings_extra.php`:

```php
use Beeralex\Reviews\Contracts\CreatorContract;
use App\Reviews\Services\ReviewCreatorService;

return [
    'services' => [
        'value' => [
            CreatorContract::class => [
                'constructor' => static function () {
                    return new ReviewCreatorService(
                        service(FileUploaderContract::class),
                        service(ReviewsRepository::class)
                    );
                }
            ],
        ]
    ]
];
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ webhook –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞

```php
namespace App\Reviews\Services;

use Beeralex\Reviews\Services\ReviewsService as BaseService;
use Beeralex\Reviews\Dto\ReviewDTO;
use Bitrix\Main\Result;
use Bitrix\Main\Web\HttpClient;

class ReviewsService extends BaseService
{
    public function add(ReviewDTO $dto, array $files): Result
    {
        $result = parent::add($dto, $files);

        if ($result->isSuccess()) {
            $this->notifyWebhook($dto, $result->getData()['elementId']);
        }

        return $result;
    }

    protected function notifyWebhook(ReviewDTO $dto, int $elementId): void
    {
        $client = new HttpClient();
        $client->post('https://your-webhook.com/reviews', [
            'review_id' => $elementId,
            'user_name' => $dto->userName,
            'rating' => $dto->eval,
            'product_id' => $dto->elementId,
            'created_at' => date('c'),
        ]);
    }
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–ø–∞–º

```php
namespace App\Reviews\Services;

use Beeralex\Reviews\Services\ReviewCreatorService as BaseCreator;
use Beeralex\Reviews\Dto\ReviewDTO;
use Bitrix\Main\Result;
use Bitrix\Main\Error;

class ReviewCreatorService extends BaseCreator
{
    public function create(ReviewDTO $dto, array $files): Result
    {
        $result = new Result();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º
        if ($this->isSpam($dto)) {
            $result->addError(new Error('–û—Ç–∑—ã–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω –∫–∞–∫ —Å–ø–∞–º'));
            return $result;
        }

        return parent::create($dto, $files);
    }

    protected function isSpam(ReviewDTO $dto): bool
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
        $spamWords = ['–∫–∞–∑–∏–Ω–æ', '–∫—Ä–µ–¥–∏—Ç', '–∑–∞–π–º', 'viagra'];
        $text = mb_strtolower($dto->review);

        foreach ($spamWords as $word) {
            if (str_contains($text, $word)) {
                return true;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –æ—Ç–∑—ã–≤–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP
        $ip = $_SERVER['REMOTE_ADDR'] ?? '';
        $recentCount = $this->repository->count([
            '>=DATE_CREATE' => date('Y-m-d H:i:s', strtotime('-1 hour')),
            'PROPERTY_IP' => $ip, // –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ IP
        ]);

        return $recentCount > 5; // –ú–∞–∫—Å–∏–º—É–º 5 –æ—Ç–∑—ã–≤–æ–≤ –≤ —á–∞—Å —Å –æ–¥–Ω–æ–≥–æ IP
    }
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–¥—É–ª—å `beeralex.notification`:

```php
namespace App\Reviews\Services;

use Beeralex\Reviews\Services\ReviewCreatorService as BaseCreator;
use Beeralex\Reviews\Dto\ReviewDTO;
use Beeralex\Notification\NotificationManager;
use Beeralex\Notification\Dto\NotificationMessage;
use Bitrix\Main\Result;

class ReviewCreatorService extends BaseCreator
{
    public function create(ReviewDTO $dto, array $files): Result
    {
        $result = parent::create($dto, $files);

        if ($result->isSuccess()) {
            $this->notifyAdmin($dto, $result->getData()['elementId']);
        }

        return $result;
    }

    protected function notifyAdmin(ReviewDTO $dto, int $elementId): void
    {
        $manager = new NotificationManager();

        $message = new NotificationMessage(
            eventName: 'NEW_REVIEW_MODERATION',
            fields: [
                'REVIEW_ID' => $elementId,
                'USER_NAME' => $dto->userName,
                'RATING' => $dto->eval,
                'REVIEW_TEXT' => $dto->review,
                'PRODUCT_ID' => $dto->elementId,
                'MODERATION_LINK' => "https://your-site.com/bitrix/admin/iblock_element_edit.php?ID={$elementId}",
            ],
            userId: 1 // ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        );

        $manager->notify($message);
    }
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞

```php
namespace App\Reviews\Validators;

use Beeralex\Reviews\Dto\ReviewDTO;
use Bitrix\Main\Error;

class ReviewValidator
{
    /**
     * –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–∑—ã–≤–∞
     */
    public static function validateExtended(ReviewDTO $dto): array
    {
        $errors = [];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
        if ($dto->eval < 3 && empty($dto->contactDetails)) {
            $errors[] = new Error('–î–ª—è –æ—Ç–∑—ã–≤–æ–≤ —Å –æ—Ü–µ–Ω–∫–æ–π –Ω–∏–∂–µ 3 —Ç—Ä–µ–±—É—é—Ç—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –¥–ª—è –≤—ã—Å–æ–∫–∏—Ö –æ—Ü–µ–Ω–æ–∫
        if ($dto->eval >= 4 && mb_strlen($dto->review) < 50) {
            $errors[] = new Error('–î–ª—è –≤—ã—Å–æ–∫–æ–π –æ—Ü–µ–Ω–∫–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–∑—ã–≤ (–º–∏–Ω–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤)');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
        $repo = service(ReviewsRepository::class);
        $existing = $repo->one([
            'PROPERTY_ELEMENT_ID' => $dto->elementId,
            'PROPERTY_USER' => $dto->userId,
            '>=DATE_CREATE' => date('Y-m-d H:i:s', strtotime('-7 days')),
        ]);

        if ($existing) {
            $errors[] = new Error('–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –≤ —Ç–µ—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π');
        }

        return $errors;
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
class ReviewCreatorService extends BaseCreator
{
    public function create(ReviewDTO $dto, array $files): Result
    {
        $result = new Result();

        // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if (!$dto->isValid()) {
            foreach ($dto->getErrors() as $error) {
                $result->addError($error);
            }
            return $result;
        }

        // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        $extendedErrors = ReviewValidator::validateExtended($dto);
        if (!empty($extendedErrors)) {
            foreach ($extendedErrors as $error) {
                $result->addError($error);
            }
            return $result;
        }

        return parent::create($dto, $files);
    }
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Ç–∑—ã–≤—ã

–†–∞—Å—à–∏—Ä—å—Ç–µ DTO:

```php
namespace App\Reviews\Dto;

use Beeralex\Reviews\Dto\ReviewDTO as BaseDTO;

class ReviewDTO extends BaseDTO
{
    /**
     * –û—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)
     */
    public ?string $officialAnswer = null;

    /**
     * –î–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞
     */
    public ?\DateTime $answerDate = null;
}
```

–û–±–Ω–æ–≤–∏—Ç–µ `prepareElementData`:

```php
protected function prepareElementData(ReviewDTO $dto): array
{
    $data = parent::prepareElementData($dto);

    if ($dto->officialAnswer) {
        $data['PROPERTY_VALUES']['OFFICIAL_ANSWER'] = [
            'TEXT' => $dto->officialAnswer,
            'TYPE' => 'HTML'
        ];
        $data['PROPERTY_VALUES']['ANSWER_DATE'] = $dto->answerDate?->format('d.m.Y H:i:s');
    }

    return $data;
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º

```php
namespace App\Reviews\Services;

use Beeralex\Reviews\Services\UploadService as BaseUpload;

class UploadService extends BaseUpload
{
    public function upload(array $files): array
    {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
        $processedFiles = $this->addWatermark($files);
        return parent::upload($processedFiles);
    }

    protected function addWatermark(array $files): array
    {
        foreach ($files['tmp_name'] as $key => $tmpPath) {
            if (!is_uploaded_file($tmpPath)) {
                continue;
            }

            $image = imagecreatefromjpeg($tmpPath);
            $watermark = imagecreatefrompng('/local/watermark.png');

            // –ù–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
            imagecopymerge(
                $image, 
                $watermark, 
                imagesx($image) - imagesx($watermark) - 10, 
                imagesy($image) - imagesy($watermark) - 10,
                0, 
                0, 
                imagesx($watermark), 
                imagesy($watermark), 
                50 // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å 50%
            );

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            imagejpeg($image, $tmpPath, 85);
            imagedestroy($image);
            imagedestroy($watermark);
        }

        return $files;
    }
}
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞

```php
use Beeralex\Reviews\Services\ReviewsService;
use Beeralex\Reviews\Dto\ReviewDTO;

$service = service(ReviewsService::class);

$dto = new ReviewDTO();
$dto->userName = '–ê–Ω–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞';
$dto->eval = 5;
$dto->review = '–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—ã–π —Ç–æ–≤–∞—Ä! –î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è, –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–ª–∏—á–Ω–æ–µ. –†–µ–∫–æ–º–µ–Ω–¥—É—é!';
$dto->contactDetails = 'anna@example.com';
$dto->elementId = 123;
$dto->userId = null; // –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π

$result = $service->add($dto, []);

if ($result->isSuccess()) {
    echo "–û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!";
} else {
    echo "–û—à–∏–±–∫–∏:\n";
    foreach ($result->getErrorMessages() as $error) {
        echo "- {$error}\n";
    }
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ —Å —Ñ–∞–π–ª–∞–º–∏

```php
// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $dto = new ReviewDTO();
    $dto->userName = $_POST['userName'];
    $dto->eval = (int)$_POST['eval'];
    $dto->review = $_POST['review'];
    $dto->contactDetails = $_POST['contactDetails'] ?? null;
    $dto->elementId = (int)$_POST['elementId'];
    $dto->userId = $USER->GetID() ?: null;

    $result = service(ReviewsService::class)->add($dto, $_FILES);

    if ($result->isSuccess()) {
        LocalRedirect('/thank-you/');
    }
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤ —Ç–æ–≤–∞—Ä–∞

```php
use Beeralex\Reviews\Repository\ReviewsRepository;

$repo = service(ReviewsRepository::class);

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤—ã —Ç–æ–≤–∞—Ä–∞
$reviews = $repo->all(
    filter: [
        'IBLOCK_SECTION_ID' => 123, // ID —Ç–æ–≤–∞—Ä–∞
        'ACTIVE' => 'Y'
    ],
    select: [
        'ID', 
        'DATE_CREATE',
        'PROPERTY_USER_NAME',
        'PROPERTY_EVAL',
        'PROPERTY_REVIEW',
        'PROPERTY_FILES',
    ],
    order: ['ID' => 'DESC']
);

foreach ($reviews as $review) {
    echo "<div class='review'>";
    echo "<strong>{$review['PROPERTY_USER_NAME_VALUE']}</strong> ";
    echo str_repeat('‚≠ê', $review['PROPERTY_EVAL_VALUE']);
    echo "<p>{$review['PROPERTY_REVIEW_VALUE']['TEXT']}</p>";
    
    if (!empty($review['PROPERTY_FILES_VALUE'])) {
        echo "<div class='photos'>";
        foreach ($review['PROPERTY_FILES_VALUE'] as $fileId) {
            $file = CFile::GetFileArray($fileId);
            echo "<img src='{$file['SRC']}' alt='–§–æ—Ç–æ'>";
        }
        echo "</div>";
    }
    echo "</div>";
}
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–æ—Ä–º—ã –æ—Ç–∑—ã–≤–∞

```php
class ReviewFormComponent extends CBitrixComponent
{
    public function executeComponent()
    {
        global $USER;

        $this->arResult['PRODUCT_ID'] = $this->arParams['PRODUCT_ID'];
        $this->arResult['USER_NAME'] = $USER->GetFullName() ?: '';
        $this->arResult['USER_ID'] = $USER->GetID();
        $this->arResult['USER_EMAIL'] = $USER->GetEmail();

        if ($this->request->isPost() && check_bitrix_sessid()) {
            $this->handleSubmit();
        }

        $this->includeComponentTemplate();
    }

    protected function handleSubmit(): void
    {
        $dto = new ReviewDTO();
        $dto->userName = $this->request->getPost('userName');
        $dto->eval = (int)$this->request->getPost('eval');
        $dto->review = $this->request->getPost('review');
        $dto->contactDetails = $this->request->getPost('contactDetails');
        $dto->elementId = (int)$this->request->getPost('elementId');
        $dto->userId = $GLOBALS['USER']->GetID() ?: null;

        $result = service(ReviewsService::class)->add($dto, $_FILES);

        if ($result->isSuccess()) {
            $this->arResult['SUCCESS'] = true;
            $this->arResult['MESSAGE'] = '–°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.';
        } else {
            $this->arResult['ERRORS'] = $result->getErrorMessages();
        }
    }
}
```

**–®–∞–±–ª–æ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:**

```php
<?php if (!empty($arResult['SUCCESS'])): ?>
    <div class="alert alert-success">
        <?= $arResult['MESSAGE'] ?>
    </div>
<?php endif; ?>

<?php if (!empty($arResult['ERRORS'])): ?>
    <div class="alert alert-danger">
        <ul>
            <?php foreach ($arResult['ERRORS'] as $error): ?>
                <li><?= htmlspecialchars($error) ?></li>
            <?php endforeach; ?>
        </ul>
    </div>
<?php endif; ?>

<form method="post" enctype="multipart/form-data">
    <?= bitrix_sessid_post() ?>
    
    <input type="hidden" name="elementId" value="<?= $arResult['PRODUCT_ID'] ?>">
    
    <div class="form-group">
        <label>–í–∞—à–µ –∏–º—è *</label>
        <input type="text" name="userName" class="form-control" 
               value="<?= htmlspecialchars($arResult['USER_NAME']) ?>" required>
    </div>

    <div class="form-group">
        <label>–û—Ü–µ–Ω–∫–∞ *</label>
        <div class="rating">
            <?php for ($i = 1; $i <= 5; $i++): ?>
                <input type="radio" name="eval" value="<?= $i ?>" id="star<?= $i ?>" required>
                <label for="star<?= $i ?>">‚≠ê</label>
            <?php endfor; ?>
        </div>
    </div>

    <div class="form-group">
        <label>–í–∞—à –æ—Ç–∑—ã–≤ *</label>
        <textarea name="review" class="form-control" rows="5" 
                  placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ..." required></textarea>
    </div>

    <div class="form-group">
        <label>Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input type="email" name="contactDetails" class="form-control" 
               value="<?= htmlspecialchars($arResult['USER_EMAIL']) ?>">
    </div>

    <div class="form-group">
        <label>–§–æ—Ç–æ (–¥–æ 5 —Ñ–∞–π–ª–æ–≤)</label>
        <input type="file" name="files[]" class="form-control" 
               accept="image/*" multiple>
    </div>

    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
</form>
```

### –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ —á–µ—Ä–µ–∑ –∞–≥–µ–Ω—Ç

```php
// –î–æ–±–∞–≤–∏—Ç—å –≤ /local/php_interface/init.php
CAgent::AddAgent(
    "\\App\\Agents\\ReviewModerationAgent::moderate();",
    "",
    "N",
    3600, // –ö–∞–∂–¥—ã–π —á–∞—Å
    "",
    "Y",
    "",
    100
);

// /local/php_interface/classes/Agents/ReviewModerationAgent.php
namespace App\Agents;

use Beeralex\Reviews\Repository\ReviewsRepository;

class ReviewModerationAgent
{
    public static function moderate(): string
    {
        $repo = service(ReviewsRepository::class);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä–∏—Ç—å –æ—Ç–∑—ã–≤—ã —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º 4-5 –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        $reviews = $repo->all([
            'ACTIVE' => 'N',
            '>=PROPERTY_EVAL' => 4,
            '!PROPERTY_USER' => false, // –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ
        ]);

        foreach ($reviews as $review) {
            $repo->update($review['ID'], ['ACTIVE' => 'Y']);
        }

        return "\\App\\Agents\\ReviewModerationAgent::moderate();";
    }
}
```

### AJAX –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∑—ã–≤–∞

**JavaScript:**

```javascript
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/api/v1/review/store/', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert('–°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.');
            e.target.reset();
        } else {
            const errors = result.errors.map(e => e.message).join('\n');
            alert('–û—à–∏–±–∫–∏:\n' + errors);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
});
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–∑—ã–≤–æ–≤

```php
use Beeralex\Reviews\Repository\ReviewsRepository;

$repo = service(ReviewsRepository::class);

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ–≤–∞—Ä—É
$productId = 123;

$allReviews = $repo->all([
    'IBLOCK_SECTION_ID' => $productId,
    'ACTIVE' => 'Y'
]);

$totalCount = count($allReviews);
$totalRating = array_sum(array_column($allReviews, 'PROPERTY_EVAL_VALUE'));
$averageRating = $totalCount > 0 ? round($totalRating / $totalCount, 1) : 0;

// –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ—Ü–µ–Ω–∫–∞–º
$ratingDistribution = [];
for ($i = 1; $i <= 5; $i++) {
    $count = count(array_filter($allReviews, fn($r) => $r['PROPERTY_EVAL_VALUE'] == $i));
    $ratingDistribution[$i] = [
        'count' => $count,
        'percent' => $totalCount > 0 ? round(($count / $totalCount) * 100) : 0
    ];
}

echo "–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {$averageRating} –∏–∑ 5 ({$totalCount} –æ—Ç–∑—ã–≤–æ–≤)\n\n";
echo "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:\n";
for ($i = 5; $i >= 1; $i--) {
    echo "{$i} ‚≠ê: {$ratingDistribution[$i]['count']} ({$ratingDistribution[$i]['percent']}%)\n";
}
```

### –í–∏–¥–∂–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç–∑—ã–≤–æ–≤

```php
class LatestReviewsComponent extends CBitrixComponent
{
    public function executeComponent()
    {
        $repo = service(ReviewsRepository::class);

        $this->arResult['REVIEWS'] = $repo->all(
            filter: ['ACTIVE' => 'Y'],
            select: [
                'ID',
                'DATE_CREATE',
                'PROPERTY_USER_NAME',
                'PROPERTY_EVAL',
                'PROPERTY_REVIEW',
                'PROPERTY_ELEMENT_ID',
            ],
            order: ['ID' => 'DESC'],
            limit: 5
        );

        $this->includeComponentTemplate();
    }
}
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

```php
$dto = new ReviewDTO();
$dto->userName = 'A'; // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ
$dto->eval = 6;       // –í–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
$dto->review = 'OK';  // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π

if (!$dto->isValid()) {
    foreach ($dto->getErrors() as $error) {
        echo $error->getMessage() . "\n";
    }
}

// –í—ã–≤–æ–¥:
// –ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤
// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ - 5
// –û—Ç–∑—ã–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 10 –¥–æ 5000 —Å–∏–º–≤–æ–ª–æ–≤
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

```php
try {
    $result = service(ReviewsService::class)->add($dto, $_FILES);
    
    if (!$result->isSuccess()) {
        $errors = $result->getErrors();
        foreach ($errors as $error) {
            logError($error->getMessage(), $error->getCode());
        }
    }
} catch (\Exception $e) {
    logCriticalError($e);
}
```

---

## –ú–∏–≥—Ä–∞—Ü–∏–∏

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ë–î.

### Version20251117100501

–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `/migrations/Version20251117100501.php`.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞ –æ—Ç–∑—ã–≤–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ –∏–º–ø–æ—Ä—Ç–∞

–û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `/logs/import_error.log`:

```php
use Beeralex\Core\Logger\FileLogger;

$logger = new FileLogger(__DIR__ . '/logs/import_error.log');
$logger->error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –æ—Ç–∑—ã–≤–∞', [
    'external_id' => '12345',
    'platform' => '2gis',
    'error' => $exception->getMessage()
]);
```

### –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏

–î–æ–±–∞–≤—å—Ç–µ –≤ `/local/php_interface/init.php`:

```php
define('REVIEWS_DEBUG', true);
```

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **beeralex.core** ‚Äî –±–∞–∑–æ–≤—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ (Repository, FileService, AbstractRequestDto)
- **beeralex.api** ‚Äî REST API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
- Bitrix/Main ‚Äî Result, Error, –≤–∞–ª–∏–¥–∞—Ü–∏—è
- Bitrix/Iblock ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –∏–Ω—Ñ–æ–±–ª–æ–∫–∞–º–∏

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã–π –º–æ–¥—É–ª—å. ¬© beeralex

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–æ–¥—É–ª—å **beeralex.reviews** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞–º–∏ —Å:

- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏–µ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ DTO
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏–µ–π
- ‚úÖ REST API
- ‚úÖ –ò–º–ø–æ—Ä—Ç–æ–º –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- ‚úÖ –ì–∏–±–∫–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —á–µ—Ä–µ–∑ `/local/.settings_extra.php`.
